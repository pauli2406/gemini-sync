{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/example/ingest-relay/schemas/connector.schema.json",
  "title": "IngestRelay Connector",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "additionalProperties": false,
  "properties": {
    "apiVersion": {"type": "string", "const": "sync.gemini.io/v1alpha1"},
    "kind": {"type": "string", "const": "Connector"},
    "metadata": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9]([a-z0-9-]{0,62}[a-z0-9])?$"
        }
      }
    },
    "spec": {
      "type": "object",
      "required": ["mode", "source", "output", "reconciliation"],
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["sql_pull", "rest_pull", "rest_push", "file_pull"]
        },
        "schedule": {"type": ["string", "null"]},
        "source": {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "enum": ["postgres", "mssql", "mysql", "oracle", "http", "file"]
            },
            "secretRef": {"type": "string", "minLength": 1},
            "query": {"type": ["string", "null"]},
            "watermarkField": {"type": ["string", "null"]},
            "url": {"type": ["string", "null"]},
            "path": {"type": ["string", "null"]},
            "glob": {"type": ["string", "null"]},
            "format": {"type": ["string", "null"], "enum": ["csv", null]},
            "csv": {
              "type": ["object", "null"],
              "additionalProperties": false,
              "properties": {
                "documentMode": {
                  "type": "string",
                  "enum": ["row", "file"],
                  "default": "row"
                },
                "delimiter": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 1,
                  "default": ","
                },
                "hasHeader": {"type": "boolean", "default": true},
                "encoding": {"type": "string", "default": "utf-8"},
                "normalizeHeaders": {"type": "boolean", "default": false},
                "cleanErrors": {"type": "boolean", "default": false}
              }
            },
            "method": {"type": "string"},
            "payload": {"type": ["object", "null"]},
            "paginationCursorField": {"type": ["string", "null"]},
            "paginationNextCursorJsonPath": {"type": ["string", "null"]},
            "headers": {
              "type": "object",
              "additionalProperties": {"type": "string"}
            },
            "oauth": {
              "type": "object",
              "required": ["tokenUrl", "clientId"],
              "additionalProperties": false,
              "properties": {
                "grantType": {
                  "type": "string",
                  "const": "client_credentials",
                  "default": "client_credentials"
                },
                "tokenUrl": {"type": "string", "minLength": 1},
                "clientId": {"type": "string", "minLength": 1},
                "clientSecretRef": {"type": ["string", "null"]},
                "scopes": {
                  "type": "array",
                  "items": {"type": "string"}
                },
                "audience": {"type": ["string", "null"]},
                "clientAuthMethod": {
                  "type": "string",
                  "enum": ["client_secret_post", "client_secret_basic"],
                  "default": "client_secret_post"
                }
              }
            }
          }
        },
        "mapping": {
          "type": "object",
          "required": ["idField", "titleField", "contentTemplate"],
          "additionalProperties": false,
          "properties": {
            "idField": {"type": "string"},
            "titleField": {"type": "string"},
            "contentTemplate": {"type": "string"},
            "uriTemplate": {"type": ["string", "null"]},
            "mimeType": {"type": "string"},
            "aclUsersField": {"type": ["string", "null"]},
            "aclGroupsField": {"type": ["string", "null"]},
            "metadataFields": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "output": {
          "type": "object",
          "required": ["bucket", "prefix", "format"],
          "additionalProperties": false,
          "properties": {
            "bucket": {
              "type": "string",
              "pattern": "^(gs|file)://"
            },
            "prefix": {"type": "string"},
            "format": {"type": "string", "enum": ["ndjson", "csv"]},
            "publishLatestAlias": {"type": "boolean", "default": false}
          }
        },
        "gemini": {
          "type": "object",
          "required": ["projectId", "location", "dataStoreId"],
          "additionalProperties": false,
          "properties": {
            "projectId": {"type": "string"},
            "location": {"type": "string"},
            "dataStoreId": {"type": "string"}
          }
        },
        "ingestion": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {"type": "boolean", "default": true}
          }
        },
        "reconciliation": {
          "type": "object",
          "required": ["deletePolicy"],
          "additionalProperties": false,
          "properties": {
            "deletePolicy": {
              "type": "string",
              "enum": ["auto_delete_missing", "soft_delete_only", "never_delete"]
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "ingestion": {
                "properties": {
                  "enabled": {"const": false}
                },
                "required": ["enabled"]
              }
            },
            "required": ["ingestion"]
          },
          "else": {
            "required": ["gemini"]
          }
        },
        {
          "if": {
            "properties": {
              "output": {
                "properties": {
                  "format": {"const": "ndjson"}
                },
                "required": ["format"]
              }
            }
          },
          "then": {
            "required": ["mapping"]
          }
        },
        {
          "if": {
            "properties": {
              "output": {
                "properties": {
                  "format": {"const": "csv"}
                },
                "required": ["format"]
              }
            }
          },
          "then": {
            "required": ["ingestion"],
            "properties": {
              "mode": {"const": "sql_pull"},
              "ingestion": {
                "required": ["enabled"],
                "properties": {
                  "enabled": {"const": false}
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "mode": {"enum": ["sql_pull", "rest_pull", "file_pull"]}
            }
          },
          "then": {
            "required": ["schedule"]
          }
        },
        {
          "if": {
            "properties": {
              "mode": {"const": "sql_pull"}
            }
          },
          "then": {
            "properties": {
              "source": {
                "properties": {
                  "type": {
                    "enum": ["postgres", "mssql", "mysql", "oracle"]
                  }
                },
                "required": ["query", "secretRef"]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "mode": {"const": "rest_pull"}
            }
          },
          "then": {
            "properties": {
              "source": {
                "properties": {
                  "type": {"const": "http"}
                },
                "required": ["url", "secretRef"]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "mode": {"const": "rest_push"}
            }
          },
          "then": {
            "properties": {
              "source": {
                "properties": {
                  "type": {"const": "http"}
                },
                "required": ["secretRef"]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "mode": {"const": "file_pull"}
            }
          },
          "then": {
            "properties": {
              "source": {
                "properties": {
                  "type": {"const": "file"},
                  "format": {"const": "csv"}
                },
                "required": ["path", "glob", "format", "csv"]
              }
            }
          }
        }
      ]
    }
  }
}
